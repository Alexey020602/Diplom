@using System.Net
@using Client.Services.Authorization
@using Refit
@inherits ErrorBoundaryBase
@inject ITokenStorage AuthorizationStorage
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

@ChildContent

@code {
    protected override void OnInitialized()
    {
        ErrorContent = Error;
    }

    private RenderFragment Error(Exception exception) => @<p>Исключение @exception.Message</p>;
    protected override async Task OnErrorAsync(Exception exception)
    {
        Console.WriteLine(exception);
        if (exception is not ApiException apiException) throw exception;
        
        Console.WriteLine(apiException);
        if (apiException. StatusCode != HttpStatusCode.Unauthorized )
        {
            Notify(exception);
            return;
        }

        Console.WriteLine("Not authorized");
        await AuthorizationStorage.RemoveAuthorization();
        NavigationManager.NavigateTo("login");
    }

    private void Notify(Exception exception)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            SummaryContent = _ => @<RadzenText>Произошлаошибка</RadzenText>,
            DetailContent = _ => @<RadzenText>@exception.Message</RadzenText>
        });
    }

}